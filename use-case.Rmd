---
title: "Use case of 'family' and 'checkout': Local CI for 'pacta'"
output: github_document
---

This article shows a use case of the packages "family" and "checkout" to work
with the "pacta" family of repositories. The goal is to test if a "work in
progress" in one repo plays well with the stable version of the other repos. It
is like a local version of the continuous-integration workflow we run on GitHub
for PACTA_analysis. It has some benefits compared to running online:

* It's faster.
* It works with uncommited changes on the focal repo.
* It does not consume our time-quota for private repo gh-actions.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Setup.

```{r}
library(magrittr)
library(family)
library(checkout)

# Helper
pick_pattern <- function(x, pattern) {
  grep(pattern, x, value = TRUE)
}
```

We start by telling the "family" package which family to focus on.

```{r}
options(family.regexp = "^[.]pacta$")
siblings()
```

Let's do some work in "StressTestingModelDev/". We could use `git` from the
terminal but here we'll show off `walk_git()`; it is a thin wrapper around
`system("git -C <path> ...")`. Here we create and checkout a new branch
"demo-pr"; modify and commit a new file; and inspect the `git log`.

```{r}
# Pretend we are working from inside StressTestingModelDev/
StressTestingModelDev <- siblings() %>% 
  pick_pattern("StressTestingModelDev")
setwd(StressTestingModelDev)

StressTestingModelDev %>% 
  walk_git("checkout -b demo-pr")

# Make some change so we have something to commit
writeLines("Some text", file.path(StressTestingModelDev, "some-file.txt"))

StressTestingModelDev %>% 
  walk_git("add .") %>% 
  walk_git("commit -m 'Add some file with some text'") %>%
  # `verbose = TRUE` prints git's output to the console
  walk_git("log --oneline --decorate -1", verbose = TRUE)
```

The other pacta siblings, say "pacta-data", may be at a non-default branch. Now
it makes more sense to use `walk_git()` because it allows us to work work with
multiple repos at once.

```{r}
siblings() %>% 
  pick_pattern("pacta-data") %>% 
  walk_git("checkout -b wip") %>%
  walk_git("branch", verbose = TRUE)
```

`checkout()` helps you checkout the default branch of every repo -- except for
the current working directory, which stays at the current reference (e.g. the
current branch or tag). This allow you to test the effect of your current work
in the context of the stable version of related project. It is inspired by the
`ref` argument of the GitHub action `checkout`.

```{r}
# Pretend we are working from inside StressTestingModelDev/
StressTestingModelDev <- siblings() %>% 
  pick_pattern("StressTestingModelDev")

setwd(StressTestingModelDev)
siblings() %>% 
  checkout()

current_branch <- "^[*] "
siblings(self = TRUE) %>%
  # Returns a list of characters, which you can operate on
  map_git("branch") %>% 
  lapply(pick_pattern, current_branch)
```

We could now use this, for example, to test if out work in progress plays well
with the web tool. This is similar to what we would otherwise do on a continuous
integration workflow online.

```{r}
PACTA_analysis <- siblings() %>% 
  pick_pattern("PACTA_analysis")

setwd(PACTA_analysis)
source(file.path(PACTA_analysis, "R", "source_web_tool_scripts.R"))
source_web_tool_scripts(1)
```

--

Cleanup.

```{r}
siblings() %>% 
  pick_pattern("pacta-data") %>% 
  walk_git("checkout master") %>% 
  walk_git("branch -D wip")

siblings() %>% 
  pick_pattern("StressTestingModelDev") %>% 
  walk_git("checkout master") %>% 
  walk_git("branch -D demo-pr")
```

